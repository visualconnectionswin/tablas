<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Tablas</title>
  <style>
    /* ----- Estilos Generales ----- */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1, h2 {
      margin-bottom: 10px;
    }

    /* ----- Zona de carga/arrastre ----- */
    #fileInput {
      margin-bottom: 10px;
    }
    .drop-zone {
      width: 100%;
      height: 100px;
      border: 2px dashed #ccc;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      color: #999;
      font-size: 14px;
      cursor: pointer;
    }
    .drop-zone:hover {
      background-color: #f9f9f9;
    }

    /* ----- Estilos para tablas ----- */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #d9d9d9;
      padding: 5px;
      text-align: center;
      vertical-align: middle;
    }
    thead th {
      background-color: #4472C4;
      color: #ffffff;
      font-weight: bold;
    }
    /* Fila de total general: fondo azul, texto negro, negrita y más grande */
    .total-row {
      background-color: #4472C4; 
      color: #000000;         
      font-weight: bold;
      font-size: 16px;        
    }
    .bold {
      font-weight: bold;
    }
    .leader-number {
      font-weight: 900;
      font-size: 14px;
    }
    .name-cell {
      text-align: left;
      padding-left: 25px;
    }
  </style>
</head>
<body>
  <h1>Generador de Tablas</h1>

  <!-- Input y zona de arrastre -->
  <input type="file" id="fileInput" accept=".xlsx, .xls, .csv"/>
  <div class="drop-zone" id="dropZone">Arrastra y suelta tu archivo aquí</div>
  
  <!-- Contenedores para las tres tablas -->
  <h2>Tabla General</h2>
  <div id="tableGeneral"></div>
  
  <h2>Tabla de Supervisores</h2>
  <div id="tableSupervisores"></div>
  
  <h2>Gestión del Back</h2>
  <div id="tableBack"></div>
  
  <!-- Librería SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    /**********************
     * FUNCIONES DE FORMATO
     **********************/
    function formatLeader(leader) {
      return leader.toUpperCase();
    }
    function formatVendor(vendor) {
      return vendor
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    // Color fijo por cada estado (si el valor es > 0)
    function getColorByState(state) {
      switch (state) {
        case "CONFORME":        return "#4CAF50"; // verde pasto
        case "AGENDADO":        return "#FAE588"; // amarillo pastel
        case "VENTA OBSERVADA": return "#FAE588"; // amarillo pastel
        case "P.GRABACIÓN":     return "#DDEBF7"; // azul pastel
        case "EN PROCESO":      return "#DDEBF7"; // azul pastel
        case "NO CONTESTA":     return "#F4B084"; // naranja pastel
        case "DESAPROBADO":     return "#FFC7CE"; // rojo pastel
        default:                return "";        // sin color
      }
    }

    // Color fijo para la columna "TOTAL GENERAL" (si el valor es > 0)
    const colorTotalGeneral = "#FAE588"; // amarillo sol

    /***************************************
     * CONFIGURACIÓN TABLA 1 Y 2 (GENERAL)
     ***************************************/
    const validStates = [
      "CONFORME",
      "P.GRABACIÓN",
      "AGENDADO",
      "NO CONTESTA",
      "VENTA OBSERVADA",
      "DESAPROBADO",
      "EN PROCESO"
    ];

    // Se deja por si en el futuro se requiere puntuar
    const stateScore = {
      "CONFORME": 0,
      "P.GRABACIÓN": 0.2,
      "EN PROCESO": 0.2,
      "AGENDADO": 0.4,
      "NO CONTESTA": 0.6,
      "VENTA OBSERVADA": 0.8,
      "DESAPROBADO": 1.0
    };

    /***************************************
     * PROCESAMIENTO DE LOS DATOS (TABLAS 1 Y 2)
     ***************************************/
    function processGeneralData(data) {
      let leaders = {};
      let globalTotals = {};
      validStates.forEach(state => { globalTotals[state] = 0; });

      // Se procesa cada fila: A (0)=vendedor, B (1)=líder, AE (30)=estado
      data.forEach(row => {
        if (row.length < 31) return;
        let vendor = row[0] ? row[0].toString().trim() : "";
        let supervisor = row[1] ? row[1].toString().trim() : "";
        let stateValue = row[30] ? row[30].toString().trim().toUpperCase() : "";
        if (!vendor || !supervisor) return;
        if (!validStates.includes(stateValue)) return;

        // Agrupar por supervisor
        if (!leaders[supervisor]) {
          leaders[supervisor] = { stateCounts: {}, vendors: {} };
          validStates.forEach(state => { leaders[supervisor].stateCounts[state] = 0; });
        }
        leaders[supervisor].stateCounts[stateValue]++;
        globalTotals[stateValue]++;

        // Agrupar vendedores por supervisor
        if (!leaders[supervisor].vendors[vendor]) {
          leaders[supervisor].vendors[vendor] = {};
          validStates.forEach(state => { leaders[supervisor].vendors[vendor][state] = 0; });
        }
        leaders[supervisor].vendors[vendor][stateValue]++;
      });

      // Columnas a mostrar: solo estados con al menos un conteo
      let columnsToShow = validStates.filter(state => globalTotals[state] > 0);

      // Calcula total de un objeto de conteo
      function calcTotal(counts) {
        return columnsToShow.reduce((acc, state) => acc + (counts[state] || 0), 0);
      }

      // Puntuación (por si más adelante se usa)
      function computeLeaderScore(stateCounts, total) {
        let sum = 0;
        columnsToShow.forEach(state => {
          sum += stateScore[state] * (stateCounts[state] || 0);
        });
        return total ? (sum / total) : 0;
      }

      // Arreglo de líderes con su total
      let leaderArray = [];
      for (let leader in leaders) {
        let total = calcTotal(leaders[leader].stateCounts);
        let score = computeLeaderScore(leaders[leader].stateCounts, total);
        leaderArray.push({
          name: leader,
          data: leaders[leader],
          total: total,
          score: score
        });
      }
      // Orden descendente por total
      leaderArray.sort((a, b) => b.total - a.total);

      return { leaderArray, columnsToShow, globalTotals, calcTotal };
    }

    /***************************************
     * CONSTRUCCIÓN DE TABLA GENERAL (Tabla 1)
     ***************************************/
    function buildTablaGeneral(leaderArray, columnsToShow, calcTotal, globalTotals) {
      let html = "<table>";
      html += "<thead><tr>";
      html += "<th>N°</th><th>LÍDER</th>";
      columnsToShow.forEach(state => { html += `<th>${state}</th>`; });
      html += "<th>TOTAL GENERAL</th>";
      html += "</tr></thead><tbody>";

      leaderArray.forEach((leaderObj, index) => {
        let leaderName = formatLeader(leaderObj.name);
        let leaderTotal = leaderObj.total;

        html += `<tr class="bold">`;
        html += `<td class="leader-number">${index + 1}</td>`;
        html += `<td style="background-color: #4a5f67; color: #fff;">${leaderName}</td>`;

        // Por cada estado, pintamos el fondo si > 0; si es 0 => fondo blanco
        columnsToShow.forEach(state => {
          let count = leaderObj.data.stateCounts[state] || 0;
          let displayCount, bgColor;

          if (count === 0) {
            displayCount = "";
            bgColor = "#ffffff"; // Celda en blanco y fondo blanco
          } else {
            displayCount = count;
            bgColor = getColorByState(state);
          }

          html += `
            <td style="background-color:${bgColor}; font-size:14px; font-weight:bold;">
              ${displayCount}
            </td>`;
        });

        // Columna "TOTAL GENERAL": si es 0 => blanco, si no => colorTotalGeneral
        let displayLeaderTotal, totalBgColor;
        if (leaderTotal === 0) {
          displayLeaderTotal = "";
          totalBgColor = "#ffffff"; 
        } else {
          displayLeaderTotal = leaderTotal;
          totalBgColor = colorTotalGeneral;
        }

        html += `
          <td style="background-color:${totalBgColor}; font-size:14px; font-weight:bold;">
            ${displayLeaderTotal}
          </td>`;
        html += "</tr>";

        // Filas de vendedores
        for (let vendor in leaderObj.data.vendors) {
          let vendorCounts = leaderObj.data.vendors[vendor];
          let vendorTotal = calcTotal(vendorCounts);

          let displayVendorTotal, vendorTotalBg;
          if (vendorTotal === 0) {
            displayVendorTotal = "";
            vendorTotalBg = "#ffffff";
          } else {
            displayVendorTotal = vendorTotal;
            vendorTotalBg = colorTotalGeneral;
          }

          html += "<tr>";
          html += "<td></td>";
          html += `<td class="name-cell">${formatVendor(vendor)}</td>`;

          columnsToShow.forEach(state => {
            let count = vendorCounts[state] || 0;
            let displayCount, bgColor;
            if (count === 0) {
              displayCount = "";
              bgColor = "#ffffff";
            } else {
              displayCount = count;
              bgColor = getColorByState(state);
            }
            html += `<td style="background-color:${bgColor};">${displayCount}</td>`;
          });

          html += `<td style="background-color:${vendorTotalBg};">${displayVendorTotal}</td>`;
          html += "</tr>";
        }
      });

      // Fila de Total general
      html += `<tr class="total-row">`;
      html += "<td></td><td>Total general</td>";

      columnsToShow.forEach(state => {
        let totalState = globalTotals[state];
        let displayTotalState, bgColor;
        if (totalState === 0) {
          displayTotalState = "";
          bgColor = "#ffffff";
        } else {
          displayTotalState = totalState;
          bgColor = getColorByState(state);
        }
        html += `<td style="background-color:${bgColor};">${displayTotalState}</td>`;
      });

      let overallTotal = columnsToShow.reduce((acc, state) => acc + globalTotals[state], 0);
      let displayOverallTotal, overallBg;
      if (overallTotal === 0) {
        displayOverallTotal = "";
        overallBg = "#ffffff";
      } else {
        displayOverallTotal = overallTotal;
        overallBg = colorTotalGeneral;
      }
      html += `<td style="background-color:${overallBg};">${displayOverallTotal}</td>`;
      html += "</tr>";

      html += "</tbody></table>";
      return html;
    }

    /*********************************************
     * CONSTRUCCIÓN DE TABLA DE SUPERVISORES (Tabla 2)
     *********************************************/
    function buildTablaSupervisores(leaderArray, columnsToShow, globalTotals) {
      let html = "<table>";
      html += "<thead><tr>";
      html += "<th>N°</th><th>LÍDER</th>";
      columnsToShow.forEach(state => { html += `<th>${state}</th>`; });
      html += "<th>TOTAL GENERAL</th>";
      html += "</tr></thead><tbody>";

      leaderArray.forEach((leaderObj, index) => {
        let leaderName = formatLeader(leaderObj.name);
        let leaderTotal = leaderObj.total;

        let displayLeaderTotal, leaderTotalBg;
        if (leaderTotal === 0) {
          displayLeaderTotal = "";
          leaderTotalBg = "#ffffff";
        } else {
          displayLeaderTotal = leaderTotal;
          leaderTotalBg = colorTotalGeneral;
        }

        html += `<tr class="bold">`;
        html += `<td class="leader-number">${index + 1}</td>`;
        html += `<td style="background-color: #4a5f67; color: #fff;">${leaderName}</td>`;

        columnsToShow.forEach(state => {
          let count = leaderObj.data.stateCounts[state] || 0;
          let displayCount, bgColor;
          if (count === 0) {
            displayCount = "";
            bgColor = "#ffffff";
          } else {
            displayCount = count;
            bgColor = getColorByState(state);
          }
          html += `
            <td style="background-color:${bgColor}; font-size:14px; font-weight:bold;">
              ${displayCount}
            </td>`;
        });

        html += `
          <td style="background-color:${leaderTotalBg}; font-size:14px; font-weight:bold;">
            ${displayLeaderTotal}
          </td>`;
        html += "</tr>";
      });

      // Total general de todos los líderes
      html += `<tr class="total-row">`;
      html += "<td></td><td>Total general</td>";

      columnsToShow.forEach(state => {
        let totalState = globalTotals[state];
        let displayTotalState, bgColor;
        if (totalState === 0) {
          displayTotalState = "";
          bgColor = "#ffffff";
        } else {
          displayTotalState = totalState;
          bgColor = getColorByState(state);
        }
        html += `<td style="background-color:${bgColor};">${displayTotalState}</td>`;
      });

      let overallTotal = columnsToShow.reduce((acc, state) => acc + globalTotals[state], 0);
      let displayOverallTotal, overallBg;
      if (overallTotal === 0) {
        displayOverallTotal = "";
        overallBg = "#ffffff";
      } else {
        displayOverallTotal = overallTotal;
        overallBg = colorTotalGeneral;
      }
      html += `<td style="background-color:${overallBg};">${displayOverallTotal}</td>`;
      html += "</tr>";

      html += "</tbody></table>";
      return html;
    }

    /*********************************************
     * PROCESAMIENTO DE DATOS PARA "GESTIÓN DEL BACK" (Tabla 3)
     *********************************************/
    function processBackData(data) {
      // AA (26)=estado, AC (28)=back
      let backData = {};
      let globalBackTotal = 0;

      data.forEach(row => {
        if (row.length < 29) return;
        let stateBack = row[26] ? row[26].toString().trim().toUpperCase() : "";
        let backName  = row[28] ? row[28].toString().trim() : "";
        if (!backName) return;

        if (!backData[backName]) {
          backData[backName] = { conforme: 0, others: 0 };
        }
        if (stateBack === "CONFORME") {
          backData[backName].conforme++;
          globalBackTotal++;
        } else if (stateBack) {
          backData[backName].others++;
          globalBackTotal++;
        }
      });

      return { backData, globalBackTotal };
    }

    function buildTablaBack(backData, globalBackTotal) {
      let html = "<table>";
      html += "<thead><tr>";
      html += "<th>BACK</th><th>CUENTA DE ESTADO DE LA VALIDACIÓN</th>";
      html += "</tr></thead><tbody>";

      let blancoCount = 0;

      for (let back in backData) {
        let conformeCount = backData[back].conforme;
        let othersCount   = backData[back].others;

        // Si es 0 => mostrar en blanco y fondo blanco
        let displayConforme, bgConforme;
        if (conformeCount === 0) {
          displayConforme = "";
          bgConforme = "#ffffff";
        } else {
          displayConforme = conformeCount;
          bgConforme = ""; // sin color
        }

        if (conformeCount > 0) {
          html += `
            <tr class="bold">
              <td>${back.toUpperCase()}</td>
              <td style="background-color:${bgConforme};">${displayConforme}</td>
            </tr>`;
        }
        if (othersCount > 0) {
          blancoCount += othersCount;
        }
      }

      // Fila "(En blanco)" si hay othersCount
      let displayBlancoCount, bgBlanco;
      if (blancoCount === 0) {
        displayBlancoCount = "";
        bgBlanco = "#ffffff";
      } else {
        displayBlancoCount = blancoCount;
        bgBlanco = ""; 
      }
      if (blancoCount > 0) {
        html += `
          <tr class="bold">
            <td>(En blanco)</td>
            <td style="background-color:${bgBlanco};">${displayBlancoCount}</td>
          </tr>`;
      }

      // Total general en la fila final
      let displayGlobalBackTotal, bgGlobalBack;
      if (globalBackTotal === 0) {
        displayGlobalBackTotal = "";
        bgGlobalBack = "#ffffff";
      } else {
        displayGlobalBackTotal = globalBackTotal;
        bgGlobalBack = "";
      }
      html += `
        <tr class="total-row">
          <td>Total general</td>
          <td style="background-color:${bgGlobalBack};">${displayGlobalBackTotal}</td>
        </tr>`;
      html += "</tbody></table>";
      return html;
    }

    /***********************
     * PROCESAMIENTO GENERAL
     ***********************/
    function processData(data) {
      // Tablas 1 y 2 (General y Supervisores)
      let { leaderArray, columnsToShow, globalTotals, calcTotal } = processGeneralData(data);
      let tablaGeneralHTML = buildTablaGeneral(leaderArray, columnsToShow, calcTotal, globalTotals);
      let tablaSupervisoresHTML = buildTablaSupervisores(leaderArray, columnsToShow, globalTotals);

      // Tabla 3 (Gestión del Back)
      let { backData, globalBackTotal } = processBackData(data);
      let tablaBackHTML = buildTablaBack(backData, globalBackTotal);

      // Inyectar cada tabla en su contenedor
      document.getElementById("tableGeneral").innerHTML = tablaGeneralHTML;
      document.getElementById("tableSupervisores").innerHTML = tablaSupervisoresHTML;
      document.getElementById("tableBack").innerHTML = tablaBackHTML;
    }

    /***********************
     * MANEJO DE ARCHIVO Y EVENTOS
     ***********************/
    function handleFile(e) {
      var files = e.target.files || e.dataTransfer.files;
      if (files.length === 0) return;
      var file = files[0];
      var reader = new FileReader();
      reader.onload = function(e) {
        var data = new Uint8Array(e.target.result);
        var workbook = XLSX.read(data, {type: 'array'});
        var firstSheetName = workbook.SheetNames[0];
        var worksheet = workbook.Sheets[firstSheetName];
        // Se saltean las primeras 2 filas (data desde la fila 3)
        var jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, range: 2});
        processData(jsonData);
      };
      reader.readAsArrayBuffer(file);
    }

    var dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', function(e) {
      e.preventDefault();
      dropZone.style.backgroundColor = "#f0f0f0";
    });
    dropZone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      dropZone.style.backgroundColor = "";
    });
    dropZone.addEventListener('drop', function(e) {
      e.preventDefault();
      dropZone.style.backgroundColor = "";
      handleFile(e);
    });

    document.getElementById('fileInput').addEventListener('change', handleFile);
  </script>
</body>
</html>
